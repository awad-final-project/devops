---
- name: Destroy Preview Environment
  hosts: dev_server
  become: true
  vars:
    # app_name must be passed via extra vars, e.g., preview-feature-1
    # Default to empty to prevent accidental deletion of root
    app_name: ""
    base_app_dir: "/opt"
    app_root: "{{ base_app_dir }}/{{ app_name }}"

  tasks:
    - name: Fail if app_name is not defined
      fail:
        msg: "app_name variable must be defined and not empty"
      when: app_name == "" or app_name is not defined

    - name: Check if app directory exists
      stat:
        path: "{{ app_root }}"
      register: app_dir_stat

    - name: Stop and remove containers
      shell: docker compose down -v
      args:
        chdir: "{{ app_root }}/devops"
      when: app_dir_stat.stat.exists
      ignore_errors: true

    - name: Remove application directory
      file:
        path: "{{ app_root }}"
        state: absent
      when: app_dir_stat.stat.exists
