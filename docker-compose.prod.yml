services:
  # ============================================
  # Local MongoDB (optional - use profile to enable/disable)
  # ============================================
  # Run WITH local MongoDB:    docker compose --profile local-db up -d
  # Run WITHOUT (use Atlas):   docker compose up -d
  # ============================================
  mongo:
    image: mongo:6.0
    container_name: mail-app-mongo
    restart: unless-stopped
    profiles: ["local-db"]  # Only starts when --profile local-db is used
    volumes:
      - mongo-data:/data/db
    environment:
      MONGO_INITDB_DATABASE: user_registration
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USER:-admin}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD:-change_me_in_production}
    healthcheck:
      test: ["CMD", "mongosh", "--quiet", "--eval", "db.runCommand('ping').ok"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - app-network
    ports:
      - "27017:27017"  # Accessible for MongoDB Compass when using local DB

  backend-prod:
    image: ghcr.io/awad-final-project/backend:latest
    container_name: mail-app-backend-prod
    restart: unless-stopped
    env_file:
      - /opt/prod/backend/.env
    environment:
      # Note: env_file variables are loaded first, then these override them
      # MONGO_URI, JWT_SECRET, etc. are read from /opt/prod/backend/.env
      # Only explicitly set variables that need different values here
      - PORT=3000
      - NODE_ENV=production
    depends_on:
      mongo:
        condition: service_healthy
        required: false  # Backend can start without mongo service
    networks:
      - app-network

  frontend-prod:
    image: ghcr.io/awad-final-project/frontend:latest
    container_name: mail-app-frontend-prod
    restart: unless-stopped
    depends_on:
      - backend-prod
    networks:
      - app-network

  # NOTE: Production does NOT have its own nginx
  # It uses the shared nginx from dev environment (mail-app-nginx)
  # Nginx config will handle routing to prod containers via domain name

volumes:
  mongo-data:

networks:
  app-network:
    external: true
    name: mail-app-network
